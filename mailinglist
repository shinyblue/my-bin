#!/bin/bash
# mailing list substitute
PREFIX=/home/rich/mailtestdir/

cd ${PREFIX}
tmp="mailertmp";
while [ -e "$tmp" ]
do tmp="${tmp}_"
done

OIFS=$IFS
IFS=
# open message body file
exec 4<>$tmp

gotheaders="no"
while read line
do
	if [ "$gotheaders" = "no" ]
	then
		header=${line//: *}
		value=${line#${header}: }
		
		if [ "$header" = "From" ] 
		then	hfrom=$value
		elif [ "$header" = "Subject" ] 
		then	hsubject=$value
		fi

		if [ "x$line"  = "x" ] 
		then gotheaders="yes"
			read filename
		fi
	else
		echo "$line" >&4
	fi
done
IFS=$OFS
exec 4>&- # close file

# emails could be one of:
# email@host.com
# user@host.com (user name)
# "user name" user@host.com
# "user name" <user@host.com>
# <user@host.com> (user name)

st=${hfrom//@*}	# delete longest pattern from start (all up to and inc.@)
st=${st##* } # delete everything except the word that joined the@
host=${hfrom//*@} # delete longest pat from end (@ onwards)
host=${host// *} # delete everything after a space
#delete < > from around email
host=${host/>}
st=${st#<}
fromsimple="${st}@${host}"

# silently drop mail not from the allowed list
if fgrep "$host" allowed >/dev/null
then
	# check if file exists
	if [ ! -f "$filename" ]
	then	{
			echo "oops!"
			echo
			cat $tmp
		} | mail -s "no file $filename!" "$fromsimple" -a "From: rich@localhost"
	else
		echo $hfrom >>$tmp

		while read toaddr
		do	cat $tmp | mail "$toaddr" -s "$hsubject" -a "From: $hfrom"
		done <${filename}
	fi
else
	{
	echo "Host $host not in allowed list."
	echo "Mail was from $hfrom."
	echo "Silently dropped mail." 
	echo
	}>>dropped
fi
rm -f $tmp
exit 0
